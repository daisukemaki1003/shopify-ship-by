# 📘 **出荷期限マネージャー 要件定義書（完全版）**

---

# **0. 目的・背景（Purpose）**

EC ショップ運営では、商品ごと・配送方法ごと・地域ごとに「出荷期限（Ship-by Date）」が異なるケースが多く、
これを手動で判断しているとミス・遅延・属人化が発生する。

特に、

- 生鮮・冷蔵・冷凍食品
- アパレル・雑貨
- 倉庫の土日休み・不定期休業
- 複数の配送方法（通常便／クール便など）

といった要素が絡むショップでは、
**お届け希望日から逆算した「出荷期限計算」が極めて煩雑** になりがちである。

この課題を解消するため、Shopify 注文データを用い、
出荷期限を自動計算してメタフィールドに保存するアプリ
**「出荷期限マネージャー」** を開発する。

---

# **1. アプリ概要（Overview）**

## **1.1 位置づけ**

Shopify における配送管理を補助するアプリであり、
「お届け希望日」を基に逆算した「出荷期限」を自動算出する仕組みを提供する。

## **1.2 対象ユーザー**

- 日本国内の中小〜中規模 EC ショップ（食品・生鮮〜アパレルまで幅広く想定）
- 物流・オペレーション担当者
- 出荷日管理を標準化したい管理者

## **1.3 解決する課題**

- 出荷日／出荷期限の計算ミス
- 商品 × 配送方法 × 都道府県 違いによる複雑な管理
- 倉庫休業日を跨ぐ計算の煩雑さ
- スタッフごとの判断のバラつき

## **1.4 用語定義**

- **お届け希望日（Delivery Date）**
  顧客が希望する商品の到着日。Metafield または Attributes に保存される。
- **出荷期限（Ship-by Date）**
  締切発送日。この日までに倉庫が出荷しなければならない。
- **日数ルール**
  「到着日の ◯ 日前に発送する」の数値。
- **配送方法マスタ**
  Shopify の配送設定（Shipping Rates）を自動取得し、ON/OFF できる機能。

---

# **2. 機能要件（Functional Requirements）**

## **2.1 自動出荷期限計算（orders/create）**

- Webhook `orders/create` 受信時に以下を実行する：

  1. お届け希望日を取得
  2. 配送方法を判定（code / metafield / attributes）
  3. 商品または配送方法に該当する日数ルールを検索
  4. 到着日 − 日数ルール で出荷期限を算出
  5. 休業日（単発・毎週）を考慮し「前営業日」にずらす
  6. 出荷期限を order metafield（date 型）に保存
  7. タグ・メモにも保存（オプション）

- エラー時はエラー一覧に記録（通知なし）

## **2.2 日数ルール設定機能**

- 条件：

  - 商品（単品）
  - 全商品
  - 配送方法

- 対象地域：

  - 複数都道府県をチェックボックスで選択

- 日数：整数（1, 2, 3, ...）

- 優先順位は
  **複数ルールが該当 → 最も日数の長いもの**
  を採用。

## **2.3 出荷期限保存**

- 以下に保存可能（ON/OFF 設定可）

  - Order Metafield（date 型）
  - タグ（フォーマット設定可）
  - メモ（フォーマット設定可）

- 日付フォーマット例：

  - タグ：`ship-by-YYYY-MM-DD`
  - メモ：`出荷期限：YYYY-MM-DD`

## **2.4 休業日カレンダー**

- ショップ全体で 1 つのカレンダーを保持
- 以下を設定可能：

  - 単発の休業日（カレンダークリック）
  - 毎週 ○ 曜日休み（複数可）

- 出荷期限が休業日に当たる場合は
  **直前の営業日に前倒し**

## **2.5 エラー一覧**

- 表示項目（全て表示）

  - 注文番号
  - 作成日時
  - お届け希望日
  - 該当配送方法
  - エラー理由
  - 処理種別（自動／手動）
  - メモ

- 行アクション：

  - 再計算
  - 除外（無視）
  - メモ追加

## **2.6 注文詳細ページでの表示**

- Shopify 標準の Order Metafield セクションに
  **出荷期限（日付）** を表示
- 専用カード画面は作らない（v2 で検討）

## **2.7 権限（OAuth スコープ）**

- read_orders
- write_orders
- read_order_metafields
- write_order_metafields
- read_products
- read_shipping
  （将来拡張のため少し広めに確保）

## **2.8 マルチテナント**

- 一般公開アプリとして、店舗ごとに完全にデータを分離
- 他ストアのデータ閲覧不可
- OAuth による認証

---

# **3. 画面要件（UI Requirements）**

## **3.1 メニュー構成（v1）**

```
出荷ルール
休業日カレンダー
エラー一覧
設定
ダッシュボード
```

## **3.2 出荷ルール画面**

- 一覧表示（最大 20 件程度想定）
- 情報項目：

  - 出荷日数
  - 対象商品 or 配送方法
  - 都道府県
  - 更新日時
  - 有効／無効

- アクション：

  - 編集
  - 複製
  - 削除

## **3.3 休業日カレンダー**

- クリックで ON/OFF
- 毎週休業設定
- 保存ボタン

## **3.4 エラー一覧**

- 全項目表示（前章参照）
- 再計算ボタン

## **3.5 設定画面**

- お届け希望日の取得元
- 日付フォーマット設定
- 配送方法判定方法
- 保存先設定（メタフィールド／タグ／メモ）
- 言語設定（初期は日本語）

## **3.6 注文詳細ページ**

- 標準メタフィールド欄に日付だけ表示

---

# **4. データ要件（Data Requirements）**

## **4.1 ルールデータモデル**

- rule_id (PK)
- shop_id
- target_type (product/all/shipping_method)
- target_id
- prefectures (string[])
- days (int)
- enabled (bool)
- created_at / updated_at

## **4.2 休業日モデル**

- shop_id
- holidays (date[])
- weekly_holidays (string[]) 例：["sun", "sat"]

## **4.3 出荷期限メタフィールド**

- namespace: `ship_by`
- key: `deadline`
- type: `date`
- value: `YYYY-MM-DD`

## **4.4 タグ・メモ**

- タグ：`ship-by-YYYY-MM-DD`
- メモ：`出荷期限：YYYY-MM-DD`

## **4.5 エラーログ**

- order_id
- reason
- raw_data
- memo
- resolved (bool)

## **4.6 店舗データ**

- shop_id
- access_token
- 設定 JSON

---

# **5. API・連携要件**

## **5.1 Admin API**

- Orders
- Order Metafields
- Products
- Shipping Rates

## **5.2 Webhook**

- `orders/create`

## **5.3 配送方法同期**

- Shipping Rates を取得
- code と title を候補として保存
- 管理者は ON/OFF を選択

## **5.4 日付パース**

- 管理者設定パターンに基づき

  - `2025/12/01`
  - `2025-12-01`
  - `12/1`
    などを解析

## **5.5 将来拡張**

- 外部配送アプリとの連携など

---

# **6. 非機能要件**

## **6.1 パフォーマンス**

- 1 注文あたり 300ms 以下で処理

## **6.2 セキュリティ**

- 全データは shop_id で分離
- Shopify OAuth 必須

## **6.3 拡張性**

- 設定は JSON で保持
- 画面はコンポーネント分離

## **6.4 言語対応**

- 初期：日本語
- 将来：英語（i18n 設計のみ用意）

## **6.5 運用・保守**

- エラー一覧で全て確認可能
- 通知機能なし（v2 以降検討）

---

# **7. 将来機能（Future Scope）**

（※ 7.1 複数倉庫対応は削除済）

7.2 国別ルール（海外対応）
7.3 タグ単位で商品ルール適用
7.4 Slack / メール通知
7.5 More actions からの再計算
7.6 AI による自動ルール生成
7.7 カレンダーの CSV インポート

---

# **8. MVP（v1）機能一覧**

- 自動出荷期限計算（orders/create）
- 商品／配送方法 × 都道府県のルール
- お届け希望日パース
- 休業日カレンダー（単発＋毎週）
- 出荷期限保存（メタフィールド・タグ・メモ）
- 注文詳細ページでの表示（メタフィールド）
- エラー一覧（再計算ボタン付き）

---

# **9. 技術構成（Tech Stack）**

## **9.1 フレームワーク**

- **Remix + Shopify API + Polaris**

## **9.2 デプロイ**

- Fly.io / Render / Railway / Vercel（Remix 対応）など

## **9.3 DB**

- Supabase（PostgreSQL）
- PlanetScale（MySQL）
- Prisma コンパチ

## **9.4 マルチテナント方式**

- shop_id を key として全データを分離管理

## **9.5 ディレクトリ構成（例）**

```
/app
  /routes
  /components
  /models
  /services
  /utils
/prisma
/public
```

---

# **10. Appendix（付録）**

- モック画面
- メタフィールド定義
- 計算フローチャート
- Shipping Rates の例
- 英語対訳表
